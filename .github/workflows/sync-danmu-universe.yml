name: 同步并打补丁（danmu-universe）

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

concurrency:
  group: danmu-sync
  cancel-in-progress: true

jobs:
  sync_patch:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装 Node 环境
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 从 CDN 下载最新脚本（带重试 + 备用镜像）
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p tmp dist

          echo "开始从 unpkg 下载..."
          if ! curl -fsSL -L \
            --retry 5 --retry-all-errors --retry-delay 2 \
            -w "%{url_effective}" \
            "https://unpkg.com/@forward-widget/danmu-universe" \
            -o "tmp/upstream.js" > "tmp/effective_url.txt"; then
            echo "unpkg 下载失败，改用 jsDelivr 备用镜像..."
            curl -fsSL -L \
              --retry 5 --retry-all-errors --retry-delay 2 \
              -w "%{url_effective}" \
              "https://cdn.jsdelivr.net/npm/@forward-widget/danmu-universe" \
              -o "tmp/upstream.js" > "tmp/effective_url.txt"
          fi

          echo "上游最终真实 URL："
          cat tmp/effective_url.txt

          sha=$(sha256sum tmp/upstream.js | awk '{print $1}')
          echo "$sha" > tmp/upstream.sha256
          echo "上游 SHA256: $sha"

      - name: 如果上游没变就跳过（避免无意义提交）
        shell: bash
        run: |
          set -euo pipefail
          if [ -f dist/upstream.sha256 ]; then
            old=$(cat dist/upstream.sha256 | tr -d '\n')
            new=$(cat tmp/upstream.sha256 | tr -d '\n')
            if [ "$old" = "$new" ]; then
              echo "上游没有变化，跳过补丁与提交。"
              echo "SKIP=1" >> $GITHUB_ENV
              exit 0
            fi
          fi
          echo "SKIP=0" >> $GITHUB_ENV

      - name: 打补丁并输出到 dist/danmu.js
        if: env.SKIP != '1'
        run: |
          node scripts/patch-danmu.js \
            tmp/upstream.js \
            dist/danmu.js \
            patch.config.json \
            --upstream-url "$(cat tmp/effective_url.txt)" \
            --upstream-sha "$(cat tmp/upstream.sha256)"

          cp tmp/upstream.sha256 dist/upstream.sha256

      - name: 有变化才提交
        if: env.SKIP != '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dist/danmu.js dist/upstream.sha256
          git diff --staged --quiet || git commit -m "chore: 同步并打补丁 danmu-universe"
          git push
